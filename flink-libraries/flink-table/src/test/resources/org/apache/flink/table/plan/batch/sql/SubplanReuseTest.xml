<?xml version="1.0" ?>
<!--
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to you under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<Root>
  <TestCase name="testBreakupDeadlock_HashJoin">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a FROM x LIMIT 10)
SELECT r1.a FROM r r1, r r2 WHERE r1.a = r2.a
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0])
+- LogicalFilter(condition=[=($0, $1)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(fetch=[10])
      :  +- LogicalProject(a=[$0])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(fetch=[10])
         +- LogicalProject(a=[$0])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a])
+- HashJoin(where=[=(a, a0)], join=[a, a0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a]], exchange_mode=[BATCH])
   :  +- Limit(offset=[0], limit=[10], global=[true], reuse_id=[1])
   :     +- Exchange(distribution=[single])
   :        +- Limit(offset=[0], limit=[10], global=[false])
   :           +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testBreakupDeadlock_NestedLoopJoin">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a FROM x LIMIT 10)
SELECT r1.a FROM r r1, r r2 WHERE r1.a = r2.a
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0])
+- LogicalFilter(condition=[=($0, $1)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(fetch=[10])
      :  +- LogicalProject(a=[$0])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(fetch=[10])
         +- LogicalProject(a=[$0])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a])
+- NestedLoopJoin(where=[=(a, a0)], join=[a, a0], joinType=[InnerJoin], build=[left])
   :- Exchange(distribution=[broadcast])
   :  +- Limit(offset=[0], limit=[10], global=[true], reuse_id=[1])
   :     +- Exchange(distribution=[single])
   :        +- Limit(offset=[0], limit=[10], global=[false])
   :           +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
   +- Exchange(distribution=[any], exchange_mode=[BATCH])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testDisableReuseTableSource">
    <Resource name="sql">
      <![CDATA[
WITH t AS (SELECT x.a AS a, x.b AS b, y.d AS d, y.e AS e FROM x, y WHERE x.a = y.d)
SELECT t1.*, t2.* FROM t t1, t t2 WHERE t1.b = t2.e AND t1.a < 10 AND t2.a > 5
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], d=[$2], e=[$3], a0=[$4], b0=[$5], d0=[$6], e0=[$7])
+- LogicalFilter(condition=[AND(=($1, $7), <($0, 10), >($4, 5))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], d=[$3], e=[$4])
      :  +- LogicalFilter(condition=[=($0, $3)])
      :     +- LogicalJoin(condition=[true], joinType=[inner])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], d=[$3], e=[$4])
         +- LogicalFilter(condition=[=($0, $3)])
            +- LogicalJoin(condition=[true], joinType=[inner])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(b, e0)], join=[a, b, d, e, a0, b0, d0, e0], joinType=[InnerJoin], build=[left])
:- Exchange(distribution=[hash[b]])
:  +- HashJoin(where=[=(a, d)], join=[a, b, d, e], joinType=[InnerJoin], build=[left])
:     :- Exchange(distribution=[hash[a]])
:     :  +- Calc(select=[a, b], where=[<(a, 10)])
:     :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
:     +- Exchange(distribution=[hash[d]])
:        +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e]]]], fields=[d, e])
+- Exchange(distribution=[hash[e]])
   +- HashJoin(where=[=(a, d)], join=[a, b, d, e], joinType=[InnerJoin], build=[left])
      :- Exchange(distribution=[hash[a]])
      :  +- Calc(select=[a, b], where=[>(a, 5)])
      :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
      +- Exchange(distribution=[hash[d]])
         +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e]]]], fields=[d, e])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testEnableReuseTableSource">
    <Resource name="sql">
      <![CDATA[
WITH t AS (SELECT x.a AS a, x.b AS b, y.d AS d, y.e AS e FROM x, y WHERE x.a = y.d)
SELECT t1.*, t2.* FROM t t1, t t2 WHERE t1.b = t2.e AND t1.a < 10 AND t2.a > 5
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], d=[$2], e=[$3], a0=[$4], b0=[$5], d0=[$6], e0=[$7])
+- LogicalFilter(condition=[AND(=($1, $7), <($0, 10), >($4, 5))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], d=[$3], e=[$4])
      :  +- LogicalFilter(condition=[=($0, $3)])
      :     +- LogicalJoin(condition=[true], joinType=[inner])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], d=[$3], e=[$4])
         +- LogicalFilter(condition=[=($0, $3)])
            +- LogicalJoin(condition=[true], joinType=[inner])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(b, e0)], join=[a, b, d, e, a0, b0, d0, e0], joinType=[InnerJoin], build=[left])
:- Exchange(distribution=[hash[b]])
:  +- HashJoin(where=[=(a, d)], join=[a, b, d, e], joinType=[InnerJoin], build=[left])
:     :- Exchange(distribution=[hash[a]])
:     :  +- Calc(select=[a, b], where=[<(a, 10)])
:     :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b], reuse_id=[1])
:     +- Exchange(distribution=[hash[d]], reuse_id=[2])
:        +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e]]]], fields=[d, e])
+- Exchange(distribution=[hash[e]], exchange_mode=[BATCH])
   +- HashJoin(where=[=(a, d)], join=[a, b, d, e], joinType=[InnerJoin], build=[left])
      :- Exchange(distribution=[hash[a]])
      :  +- Calc(select=[a, b], where=[>(a, 5)])
      :     +- Reused(reference_id=[1])
      +- Reused(reference_id=[2])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testNestedReusableSubplan">
    <Resource name="sql">
      <![CDATA[
WITH v1 AS (
 SELECT
   SUM(b) sum_b,
   AVG(SUM(b)) OVER (PARTITION BY c, e) avg_b,
   RANK() OVER (PARTITION BY c, e ORDER BY c, e) rn,
   c, e
 FROM x, y
 WHERE x.a = y.d AND c IS NOT NULl AND e > 10
 GROUP BY c, e
),
   v2 AS (
 SELECT
    v11.c,
    v11.e,
    v11.avg_b,
    v11.sum_b,
    v12.sum_b psum,
    v13.sum_b nsum,
    v12.avg_b avg_b2
  FROM v1 v11, v1 v12, v1 v13
  WHERE v11.c = v12.c AND v11.c = v13.c AND
    v11.e = v12.e AND v11.e = v13.e AND
    v11.rn = v12.rn + 1 AND
    v11.rn = v13.rn - 1
)
SELECT * from v2 WHERE c <> '' AND sum_b - avg_b > 3
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], e=[$1], avg_b=[$2], sum_b=[$3], psum=[$4], nsum=[$5], avg_b2=[$6])
+- LogicalFilter(condition=[AND(<>($0, ''), >(-($3, $2), 3))])
   +- LogicalProject(c=[$3], e=[$4], avg_b=[$1], sum_b=[$0], psum=[$5], nsum=[$10], avg_b2=[$6])
      +- LogicalFilter(condition=[AND(=($3, $8), =($3, $13), =($4, $9), =($4, $14), =($2, +($7, 1)), =($2, -($12, 1)))])
         +- LogicalJoin(condition=[true], joinType=[inner])
            :- LogicalJoin(condition=[true], joinType=[inner])
            :  :- LogicalProject(sum_b=[$2], avg_b=[/(CAST(CASE(>(COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING), 0), CAST($SUM0($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)):BIGINT, null)):DOUBLE, COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))], rn=[RANK() OVER (PARTITION BY $0, $1 ORDER BY $0 NULLS FIRST, $1 NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)], c=[$0], e=[$1])
            :  :  +- LogicalAggregate(group=[{0, 1}], sum_b=[SUM($2)])
            :  :     +- LogicalProject(c=[$2], e=[$4], b=[$1])
            :  :        +- LogicalFilter(condition=[AND(=($0, $3), IS NOT NULL($2), >($4, 10))])
            :  :           +- LogicalJoin(condition=[true], joinType=[inner])
            :  :              :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
            :  :              +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
            :  +- LogicalProject(sum_b=[$2], avg_b=[/(CAST(CASE(>(COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING), 0), CAST($SUM0($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)):BIGINT, null)):DOUBLE, COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))], rn=[RANK() OVER (PARTITION BY $0, $1 ORDER BY $0 NULLS FIRST, $1 NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)], c=[$0], e=[$1])
            :     +- LogicalAggregate(group=[{0, 1}], sum_b=[SUM($2)])
            :        +- LogicalProject(c=[$2], e=[$4], b=[$1])
            :           +- LogicalFilter(condition=[AND(=($0, $3), IS NOT NULL($2), >($4, 10))])
            :              +- LogicalJoin(condition=[true], joinType=[inner])
            :                 :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
            :                 +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
            +- LogicalProject(sum_b=[$2], avg_b=[/(CAST(CASE(>(COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING), 0), CAST($SUM0($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)):BIGINT, null)):DOUBLE, COUNT($2) OVER (PARTITION BY $0, $1 RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING))], rn=[RANK() OVER (PARTITION BY $0, $1 ORDER BY $0 NULLS FIRST, $1 NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)], c=[$0], e=[$1])
               +- LogicalAggregate(group=[{0, 1}], sum_b=[SUM($2)])
                  +- LogicalProject(c=[$2], e=[$4], b=[$1])
                     +- LogicalFilter(condition=[AND(=($0, $3), IS NOT NULL($2), >($4, 10))])
                        +- LogicalJoin(condition=[true], joinType=[inner])
                           :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
                           +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, e, avg_b, sum_b, sum_b0 AS psum, sum_b1 AS nsum, avg_b0 AS avg_b2])
+- HashJoin(where=[AND(=(c, c0), =(e, e0), =(rn, $f5))], join=[sum_b, avg_b, rn, c, e, sum_b0, avg_b0, sum_b1, c0, e0, $f5], joinType=[InnerJoin], isBroadcast=[true], build=[left])
   :- Exchange(distribution=[broadcast])
   :  +- Calc(select=[sum_b, avg_b, rn, c, e, sum_b0, avg_b0])
   :     +- HashJoin(where=[AND(=(c, c0), =(e, e0), =(rn, $f5))], join=[sum_b, avg_b, rn, c, e, sum_b0, avg_b0, c0, e0, $f5], joinType=[InnerJoin], isBroadcast=[true], build=[left])
   :        :- Exchange(distribution=[broadcast])
   :        :  +- Calc(select=[sum_b, /(CAST(CASE(>(w0$o0, 0), CAST(w0$o1), null)), w0$o0) AS avg_b, w1$o0 AS rn, c, e], where=[AND(<>(c, ''), >(-(sum_b, /(CAST(CASE(>(w0$o0, 0), CAST(w0$o1), null)), w0$o0)), 3))])
   :        :     +- OverAggregate(partitionBy=[c, e], orderBy=[], window#0=[COUNT(sum_b) AS w0$o0, $SUM0(sum_b) AS w0$o1 RANG BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING], window#1=[RANK(*) AS w1$o0 RANG BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW], select=[c, e, sum_b, w0$o0, w0$o1, w1$o0], reuse_id=[1])
   :        :        +- Sort(orderBy=[c ASC, e ASC], reuse_id=[2])
   :        :           +- HashAggregate(isMerge=[true], groupBy=[c, e], select=[c, e, Final_SUM(sum$0) AS sum_b])
   :        :              +- Exchange(distribution=[hash[c, e]])
   :        :                 +- LocalHashAggregate(groupBy=[c, e], select=[c, e, Partial_SUM(b) AS sum$0])
   :        :                    +- Calc(select=[c, e, b])
   :        :                       +- HashJoin(where=[=(a, d)], join=[a, b, c, d, e], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :        :                          :- Calc(select=[a, b, c], where=[IS NOT NULL(c)])
   :        :                          :  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   :        :                          +- Exchange(distribution=[broadcast])
   :        :                             +- Calc(select=[d, e], where=[>(e, 10)])
   :        :                                +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e]]]], fields=[d, e])
   :        +- Exchange(distribution=[hash[c, e, $f5]], exchange_mode=[BATCH])
   :           +- Calc(select=[sum_b, /(CAST(CASE(>(w0$o0, 0), CAST(w0$o1), null)), w0$o0) AS avg_b, c, e, +(w1$o0, 1) AS $f5])
   :              +- Reused(reference_id=[1])
   +- Exchange(distribution=[hash[c, e, $f5]], exchange_mode=[BATCH])
      +- Calc(select=[sum_b, c, e, -(w0$o0, 1) AS $f5])
         +- OverAggregate(partitionBy=[c, e], orderBy=[c ASC, e ASC], window#0=[RANK(*) AS w0$o0 RANG BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW], select=[c, e, sum_b, w0$o0])
            +- Reused(reference_id=[2])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_DeterministicJoinCondition">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x FULL OUTER JOIN y ON ABS(a) = ABS(d) OR c = f
           WHERE b > 1 and e < 2)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=(CAST($0):BIGINT, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
      :     +- LogicalJoin(condition=[OR(=(ABS($0), ABS($3)), =($2, $5))], joinType=[full])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
            +- LogicalJoin(condition=[OR(=(ABS($0), ABS($3)), =($2, $5))], joinType=[full])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, b, c, d, e, f, a1 AS a0, b0, c0, d0, e0, f0])
+- HashJoin(where=[=(a0, b0)], join=[a, b, c, d, e, f, a0, a1, b0, c0, d0, e0, f0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[a, b, c, d, e, f, CAST(a) AS a0])
   :     +- NestedLoopJoin(where=[OR(=(ABS(a), ABS(d)), =(c, f))], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left], reuse_id=[1])
   :        :- Exchange(distribution=[broadcast])
   :        :  +- Calc(select=[a, b, c], where=[>(b, 1)])
   :        :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   :        +- Calc(select=[d, e, f], where=[<(e, 2)])
   :           +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_DynamicFunction">
    <Resource name="planBefore">
      <![CDATA[
LogicalIntersect(all=[false])
:- LogicalIntersect(all=[false])
:  :- LogicalProject(random=[$0])
:  :  +- LogicalSort(sort0=[$1], dir0=[ASC-nulls-first], fetch=[1])
:  :     +- LogicalProject(random=[$0], EXPR$1=[RAND()])
:  :        +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
:  +- LogicalProject(random=[$0])
:     +- LogicalSort(sort0=[$1], dir0=[ASC-nulls-first], fetch=[1])
:        +- LogicalProject(random=[$0], EXPR$1=[RAND()])
:           +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
+- LogicalProject(random=[$0])
   +- LogicalSort(sort0=[$1], dir0=[ASC-nulls-first], fetch=[1])
      +- LogicalProject(random=[$0], EXPR$1=[RAND()])
         +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
NestedLoopSemiJoin(where=[OR(=(random, random0), AND(IS NULL(random), IS NULL(random0)))], join=[random], joinType=[LeftSemiJoin], build=[right])
:- SortAggregate(isMerge=[false], groupBy=[random], select=[random])
:  +- Sort(orderBy=[random ASC])
:     +- Exchange(distribution=[hash[random]])
:        +- NestedLoopSemiJoin(where=[OR(=(random, random0), AND(IS NULL(random), IS NULL(random0)))], join=[random], joinType=[LeftSemiJoin], build=[right])
:           :- Calc(select=[random])
:           :  +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[true])
:           :     +- Exchange(distribution=[single])
:           :        +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[false])
:           :           +- Calc(select=[a AS random, RAND() AS EXPR$1])
:           :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
:           +- Exchange(distribution=[broadcast])
:              +- Calc(select=[random])
:                 +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[true])
:                    +- Exchange(distribution=[single])
:                       +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[false])
:                          +- Calc(select=[a AS random, RAND() AS EXPR$1])
:                             +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
+- Exchange(distribution=[broadcast])
   +- Calc(select=[random])
      +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[true])
         +- Exchange(distribution=[single])
            +- SortLimit(orderBy=[EXPR$1 ASC], offset=[0], limit=[1], global=[false])
               +- Calc(select=[a AS random, RAND() AS EXPR$1])
                  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicAgg_Disabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, MyFirst(a) a, MyLast(b) b FROM x GROUP BY c)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r2.a > 1
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($4, 1))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalAggregate(group=[{0}], a=[MyFirst($1)], b=[MyLast($2)])
      :  +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalAggregate(group=[{0}], a=[MyFirst($1)], b=[MyLast($2)])
         +- LogicalProject(c=[$2], a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- HashJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0])
   :     +- SortAggregate(isMerge=[false], groupBy=[c], select=[c, MyFirst(a) AS a, MyLast(b) AS b])
   :        +- Sort(orderBy=[c ASC], reuse_id=[1])
   :           +- Exchange(distribution=[hash[c]])
   :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[>(a, 1)])
         +- SortAggregate(isMerge=[false], groupBy=[c], select=[c, MyFirst(a) AS a, MyLast(b) AS b])
            +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicAgg_Enabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, MyFirst(a) a, MyLast(b) b FROM x GROUP BY c)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r2.a > 1
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($4, 1))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalAggregate(group=[{0}], a=[MyFirst($1)], b=[MyLast($2)])
      :  +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalAggregate(group=[{0}], a=[MyFirst($1)], b=[MyLast($2)])
         +- LogicalProject(c=[$2], a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- HashJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0])
   :     +- SortAggregate(isMerge=[false], groupBy=[c], select=[c, MyFirst(a) AS a, MyLast(b) AS b], reuse_id=[1])
   :        +- Sort(orderBy=[c ASC])
   :           +- Exchange(distribution=[hash[c]])
   :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[>(a, 1)])
         +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicJoinCondition_Disabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x FULL OUTER JOIN y ON random_udf(a) = random_udf(d) OR c = f
           WHERE b > 1 and e < 2)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=(CAST($0):BIGINT, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
      :     +- LogicalJoin(condition=[OR(=(random_udf($0), random_udf($3)), =($2, $5))], joinType=[full])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
            +- LogicalJoin(condition=[OR(=(random_udf($0), random_udf($3)), =($2, $5))], joinType=[full])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, b, c, d, e, f, a1 AS a0, b0, c0, d0, e0, f0])
+- HashJoin(where=[=(a0, b0)], join=[a, b, c, d, e, f, a0, a1, b0, c0, d0, e0, f0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[a, b, c, d, e, f, CAST(a) AS a0])
   :     +- NestedLoopJoin(where=[OR(=(random_udf(a), random_udf(d)), =(c, f))], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left])
   :        :- Exchange(distribution=[broadcast], reuse_id=[1])
   :        :  +- Calc(select=[a, b, c], where=[>(b, 1)])
   :        :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   :        +- Calc(select=[d, e, f], where=[<(e, 2)], reuse_id=[2])
   :           +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
   +- Exchange(distribution=[broadcast])
      +- NestedLoopJoin(where=[OR(=(random_udf(a), random_udf(d)), =(c, f))], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left])
         :- Reused(reference_id=[1])
         +- Reused(reference_id=[2])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicJoinCondition_Enabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x FULL OUTER JOIN y ON random_udf(a) = random_udf(d) OR c = f
           WHERE b > 1 and e < 2)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=(CAST($0):BIGINT, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
      :     +- LogicalJoin(condition=[OR(=(random_udf($0), random_udf($3)), =($2, $5))], joinType=[full])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(>($1, 1), <($4, 2))])
            +- LogicalJoin(condition=[OR(=(random_udf($0), random_udf($3)), =($2, $5))], joinType=[full])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, b, c, d, e, f, a1 AS a0, b0, c0, d0, e0, f0])
+- HashJoin(where=[=(a0, b0)], join=[a, b, c, d, e, f, a0, a1, b0, c0, d0, e0, f0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[a, b, c, d, e, f, CAST(a) AS a0])
   :     +- NestedLoopJoin(where=[OR(=(random_udf(a), random_udf(d)), =(c, f))], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left], reuse_id=[1])
   :        :- Exchange(distribution=[broadcast])
   :        :  +- Calc(select=[a, b, c], where=[>(b, 1)])
   :        :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   :        +- Calc(select=[d, e, f], where=[<(e, 2)])
   :           +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicUdfOnFilter">
    <Resource name="sql">
      <![CDATA[
(SELECT a FROM x WHERE b > random_udf(a))
UNION ALL
(SELECT a FROM x WHERE b > random_udf(a))
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalUnion(all=[true])
:- LogicalProject(a=[$0])
:  +- LogicalFilter(condition=[>($1, random_udf($0))])
:     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
+- LogicalProject(a=[$0])
   +- LogicalFilter(condition=[>($1, random_udf($0))])
      +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Union(all=[true], union=[a])
:- Calc(select=[a])
:  +- Calc(select=[a, b], where=[>(b, random_udf(a))])
:     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
+- Calc(select=[a])
   +- Calc(select=[a, b], where=[>(b, random_udf(a))])
      +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicUdfOnProject">
    <Resource name="sql">
      <![CDATA[
(SELECT a, random_udf() FROM x WHERE a > 10)
UNION ALL
(SELECT a, random_udf() FROM x WHERE a > 10)
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalUnion(all=[true])
:- LogicalProject(a=[$0], EXPR$1=[random_udf()])
:  +- LogicalFilter(condition=[>($0, 10)])
:     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
+- LogicalProject(a=[$0], EXPR$1=[random_udf()])
   +- LogicalFilter(condition=[>($0, 10)])
      +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Union(all=[true], union=[a, EXPR$1])
:- Calc(select=[a, random_udf() AS EXPR$1])
:  +- Calc(select=[a], where=[>(a, 10)], reuse_id=[1])
:     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a]]]], fields=[a])
+- Calc(select=[a, random_udf() AS EXPR$1])
   +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicUDTF_Disabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, c, s FROM x, LATERAL TABLE(MyTable(c)) AS T(s))
SELECT * FROM r r1, r r2 WHERE r1.c = r2.s
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3], a0=[$4], b0=[$5], c0=[$6], s0=[$7])
+- LogicalFilter(condition=[=($2, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3])
      :  +- LogicalCorrelate(correlation=[$cor0], joinType=[inner], requiredColumns=[{2}])
      :     :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :     +- LogicalTableFunctionScan(invocation=[MyTable($cor0.c)], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3])
         +- LogicalCorrelate(correlation=[$cor1], joinType=[inner], requiredColumns=[{2}])
            :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
            +- LogicalTableFunctionScan(invocation=[MyTable($cor1.c)], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(c, f00)], join=[a, b, c, f0, a0, b0, c0, f00], joinType=[InnerJoin], isBroadcast=[true], build=[right])
:- Correlate(invocation=[MyTable($cor0.c)], correlate=[table(MyTable($cor0.c))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
:  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
+- Exchange(distribution=[broadcast])
   +- Correlate(invocation=[MyTable($cor1.c)], correlate=[table(MyTable($cor1.c))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
      +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testReusableSubplan_NonDeterministicUDTF_Enabled">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, c, s FROM x, LATERAL TABLE(MyTable(c)) AS T(s))
SELECT * FROM r r1, r r2 WHERE r1.c = r2.s
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3], a0=[$4], b0=[$5], c0=[$6], s0=[$7])
+- LogicalFilter(condition=[=($2, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3])
      :  +- LogicalCorrelate(correlation=[$cor0], joinType=[inner], requiredColumns=[{2}])
      :     :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :     +- LogicalTableFunctionScan(invocation=[MyTable($cor0.c)], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], s=[$3])
         +- LogicalCorrelate(correlation=[$cor1], joinType=[inner], requiredColumns=[{2}])
            :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
            +- LogicalTableFunctionScan(invocation=[MyTable($cor1.c)], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(c, f00)], join=[a, b, c, f0, a0, b0, c0, f00], joinType=[InnerJoin], isBroadcast=[true], build=[right])
:- Correlate(invocation=[MyTable($cor0.c)], correlate=[table(MyTable($cor0.c))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
:  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
+- Exchange(distribution=[broadcast])
   +- Correlate(invocation=[MyTable($cor1.c)], correlate=[table(MyTable($cor1.c))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
      +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Calc">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, c FROM x WHERE c LIKE 'test%')
(SELECT r.a, LOWER(c) AS c, y.e FROM r, y WHERE r.a = y.d)
UNION ALL
(SELECT r.a, LOWER(c) AS c, y.e FROM r, y WHERE r.a = y.d)
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalUnion(all=[true])
:- LogicalProject(a=[$0], c=[LOWER($2)], e=[$4])
:  +- LogicalFilter(condition=[=($0, $3)])
:     +- LogicalJoin(condition=[true], joinType=[inner])
:        :- LogicalProject(a=[$0], b=[$1], c=[$2])
:        :  +- LogicalFilter(condition=[LIKE($2, 'test%')])
:        :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
:        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
+- LogicalProject(a=[$0], c=[LOWER($2)], e=[$4])
   +- LogicalFilter(condition=[=($0, $3)])
      +- LogicalJoin(condition=[true], joinType=[inner])
         :- LogicalProject(a=[$0], b=[$1], c=[$2])
         :  +- LogicalFilter(condition=[LIKE($2, 'test%')])
         :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
         +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Union(all=[true], union=[a, c, e])
:- Calc(select=[a, LOWER(c) AS c, e], reuse_id=[1])
:  +- HashJoin(where=[=(a, d)], join=[a, c, d, e], joinType=[InnerJoin], isBroadcast=[true], build=[left])
:     :- Exchange(distribution=[broadcast])
:     :  +- Calc(select=[a, c], where=[LIKE(c, 'test%')])
:     :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, c]]]], fields=[a, c])
:     +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e]]]], fields=[d, e])
+- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Correlate">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, c, v FROM x, LATERAL TABLE(STRING_SPLIT(c, '-')) AS T(v))
SELECT * FROM r r1, r r2 WHERE r1.v = r2.v
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], v=[$3], a0=[$4], b0=[$5], c0=[$6], v0=[$7])
+- LogicalFilter(condition=[=($3, $7)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], v=[$3])
      :  +- LogicalCorrelate(correlation=[$cor0], joinType=[inner], requiredColumns=[{2}])
      :     :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :     +- LogicalTableFunctionScan(invocation=[STRING_SPLIT($cor0.c, '-')], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], v=[$3])
         +- LogicalCorrelate(correlation=[$cor1], joinType=[inner], requiredColumns=[{2}])
            :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
            +- LogicalTableFunctionScan(invocation=[STRING_SPLIT($cor1.c, '-')], rowType=[RecordType(VARCHAR(65536) f0)], elementType=[class [Ljava.lang.Object;])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(f0, f00)], join=[a, b, c, f0, a0, b0, c0, f00], joinType=[InnerJoin], isBroadcast=[true], build=[right])
:- Correlate(invocation=[STRING_SPLIT($cor0.c, '-')], correlate=[table(STRING_SPLIT($cor0.c,'-'))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
:  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
+- Exchange(distribution=[broadcast])
   +- Correlate(invocation=[STRING_SPLIT($cor1.c, '-')], correlate=[table(STRING_SPLIT($cor1.c,'-'))], select=[a,b,c,f0], rowType=[RecordType(INTEGER a, BIGINT b, VARCHAR(65536) c, VARCHAR(65536) f0)], joinType=[INNER])
      +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Exchange">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, c FROM x WHERE c LIKE 'test%')
SELECT * FROM r, y WHERE a = d AND e > 10
UNION ALL
SELECT * FROM r, y WHERE a = d AND f <> ''
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalUnion(all=[true])
:- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
:  +- LogicalFilter(condition=[AND(=($0, $3), >($4, 10))])
:     +- LogicalJoin(condition=[true], joinType=[inner])
:        :- LogicalProject(a=[$0], b=[$1], c=[$2])
:        :  +- LogicalFilter(condition=[LIKE($2, 'test%')])
:        :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
:        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
+- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
   +- LogicalFilter(condition=[AND(=($0, $3), <>($5, ''))])
      +- LogicalJoin(condition=[true], joinType=[inner])
         :- LogicalProject(a=[$0], b=[$1], c=[$2])
         :  +- LogicalFilter(condition=[LIKE($2, 'test%')])
         :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
         +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Union(all=[true], union=[a, b, c, d, e, f])
:- HashJoin(where=[=(a, d)], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left])
:  :- Exchange(distribution=[hash[a]], reuse_id=[1])
:  :  +- Calc(select=[a, b, c], where=[LIKE(c, 'test%')])
:  :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
:  +- Exchange(distribution=[hash[d]])
:     +- Calc(select=[d, e, f], where=[>(e, 10)])
:        +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
+- HashJoin(where=[=(a, d)], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left])
   :- Reused(reference_id=[1])
   +- Exchange(distribution=[hash[d]])
      +- Calc(select=[d, e, f], where=[<>(f, '')])
         +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_HashAggregate">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, SUM(a) a, SUM(b) b FROM x GROUP BY c)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r2.a > 1
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($4, 1))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
      :  +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
         +- LogicalProject(c=[$2], a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- HashJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0])
   :     +- HashAggregate(isMerge=[true], groupBy=[c], select=[c, Final_SUM(sum$0) AS a, Final_SUM(sum$1) AS b], reuse_id=[1])
   :        +- Exchange(distribution=[hash[c]])
   :           +- LocalHashAggregate(groupBy=[c], select=[c, Partial_SUM(a) AS sum$0, Partial_SUM(b) AS sum$1])
   :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[>(a, 1)])
         +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_HashJoin">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x, y WHERE a = d AND c LIKE 'He%')
SELECT * FROM r r1, r r2 WHERE r1.a = r2.d
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=($0, $9)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
      :     +- LogicalJoin(condition=[true], joinType=[inner])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
            +- LogicalJoin(condition=[true], joinType=[inner])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(a, d0)], join=[a, b, c, d, e, f, a0, b0, c0, d0, e0, f0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
:- Exchange(distribution=[hash[a]], exchange_mode=[BATCH])
:  +- HashJoin(where=[=(a, d)], join=[a, b, c, d, e, f], joinType=[InnerJoin], isBroadcast=[true], build=[left], reuse_id=[1])
:     :- Exchange(distribution=[broadcast])
:     :  +- Calc(select=[a, b, c], where=[LIKE(c, 'He%')])
:     :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
:     +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
+- Exchange(distribution=[broadcast])
   +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Limit">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b FROM x LIMIT 10)
SELECT r1.a, r1.b, r2.a FROM r r1, r r2 WHERE r1.a = r2.b
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], a0=[$2])
+- LogicalFilter(condition=[=(CAST($0):BIGINT, $3)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(fetch=[10])
      :  +- LogicalProject(a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(fetch=[10])
         +- LogicalProject(a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, b, a1 AS a0])
+- NestedLoopJoin(where=[=(a0, b0)], join=[a, b, a0, a1, b0], joinType=[InnerJoin], build=[right])
   :- Exchange(distribution=[any], exchange_mode=[BATCH])
   :  +- Calc(select=[a, b, CAST(a) AS a0])
   :     +- Limit(offset=[0], limit=[10], global=[true], reuse_id=[1])
   :        +- Exchange(distribution=[single])
   :           +- Limit(offset=[0], limit=[10], global=[false])
   :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_NestedLoopJoin">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x, y WHERE a = d AND c LIKE 'He%')
SELECT * FROM r r1, r r2 WHERE r1.a = r2.d
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=($0, $9)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
      :     +- LogicalJoin(condition=[true], joinType=[inner])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
            +- LogicalJoin(condition=[true], joinType=[inner])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
NestedLoopJoin(where=[=(a, d0)], join=[a, b, c, d, e, f, a0, b0, c0, d0, e0, f0], joinType=[InnerJoin], build=[left])
:- Exchange(distribution=[broadcast])
:  +- NestedLoopJoin(where=[=(a, d)], join=[a, b, c, d, e, f], joinType=[InnerJoin], build=[left], reuse_id=[1])
:     :- Exchange(distribution=[broadcast])
:     :  +- Calc(select=[a, b, c], where=[LIKE(c, 'He%')])
:     :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
:     +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
+- Exchange(distribution=[any], exchange_mode=[BATCH])
   +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_OverWindow">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b, RANK() OVER (ORDER BY c DESC) FROM x)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.a AND r1.b < 100 AND r2.b > 10
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], EXPR$2=[$2], a0=[$3], b0=[$4], EXPR$20=[$5])
+- LogicalFilter(condition=[AND(=($0, $3), <($1, 100), >($4, 10))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], EXPR$2=[RANK() OVER (ORDER BY $2 DESC NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)])
      :  +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalProject(a=[$0], b=[$1], EXPR$2=[RANK() OVER (ORDER BY $2 DESC NULLS LAST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)])
         +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
HashJoin(where=[=(a, a0)], join=[a, b, $2, a0, b0, $20], joinType=[InnerJoin], isBroadcast=[true], build=[right])
:- Exchange(distribution=[hash[a]], exchange_mode=[BATCH])
:  +- Calc(select=[a, b, w0$o0 AS $2], where=[<(b, 100)])
:     +- OverAggregate(orderBy=[c DESC], window#0=[RANK(*) AS w0$o0 RANG BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW], select=[a, b, c, w0$o0], reuse_id=[1])
:        +- Sort(orderBy=[c DESC])
:           +- Exchange(distribution=[single])
:              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
+- Exchange(distribution=[broadcast])
   +- Calc(select=[a, b, w0$o0 AS $2], where=[>(b, 10)])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_SortAggregate">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, SUM(a) a, SUM(b) b FROM x GROUP BY c)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r2.a > 1
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($4, 1))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
      :  +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
         +- LogicalProject(c=[$2], a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- HashJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a0]], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0])
   :     +- SortAggregate(isMerge=[true], groupBy=[c], select=[c, Final_SUM(sum$0) AS a, Final_SUM(sum$1) AS b], reuse_id=[1])
   :        +- Sort(orderBy=[c ASC])
   :           +- Exchange(distribution=[hash[c]])
   :              +- LocalSortAggregate(groupBy=[c], select=[c, Partial_SUM(a) AS sum$0, Partial_SUM(b) AS sum$1])
   :                 +- Sort(orderBy=[c ASC])
   :                    +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[>(a, 1)])
         +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_ScanTable">
    <Resource name="sql">
      <![CDATA[
(SELECT a FROM t WHERE a > 10)
UNION ALL
(SELECT a FROM t WHERE b > 10)
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalUnion(all=[true])
:- LogicalProject(a=[$0])
:  +- LogicalFilter(condition=[>($0, 10)])
:     +- LogicalTableScan(table=[[builtin, default, t]])
+- LogicalProject(a=[$0])
   +- LogicalFilter(condition=[>($1, 10)])
      +- LogicalTableScan(table=[[builtin, default, t]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Union(all=[true], union=[a])
:- Calc(select=[a], where=[>(a, 10)])
:  +- BoundedStreamScan(table=[[builtin, default, _DataStreamTable_0]], fields=[a, b, c], reuse_id=[1])
+- Calc(select=[a], where=[>(b, 10)])
   +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_SortMergeJoin">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT * FROM x, y WHERE a = d AND c LIKE 'He%')
SELECT * FROM r r1, r r2 WHERE r1.a = r2.d
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5], a0=[$6], b0=[$7], c0=[$8], d0=[$9], e0=[$10], f0=[$11])
+- LogicalFilter(condition=[=($0, $9)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
      :  +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
      :     +- LogicalJoin(condition=[true], joinType=[inner])
      :        :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalProject(a=[$0], b=[$1], c=[$2], d=[$3], e=[$4], f=[$5])
         +- LogicalFilter(condition=[AND(=($0, $3), LIKE($2, 'He%'))])
            +- LogicalJoin(condition=[true], joinType=[inner])
               :- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
SortMergeJoin(where=[=(a, d0)], join=[a, b, c, d, e, f, a0, b0, c0, d0, e0, f0], joinType=[InnerJoin], leftSorted=[true], rightSorted=[true])
:- SortMergeJoin(where=[=(a, d)], join=[a, b, c, d, e, f], joinType=[InnerJoin], reuse_id=[1])
:  :- Exchange(distribution=[hash[a]])
:  :  +- Calc(select=[a, b, c], where=[LIKE(c, 'He%')])
:  :     +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
:  +- Exchange(distribution=[hash[d]])
:     +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
+- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Sort">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, SUM(a) a, SUM(b) b FROM x GROUP BY c ORDER BY a, b DESC)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r1.a > 1 AND r2.b < 10
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($1, 1), <($5, 10))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(sort0=[$1], sort1=[$2], dir0=[ASC-nulls-first], dir1=[DESC-nulls-last])
      :  +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
      :     +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :        +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(sort0=[$1], sort1=[$2], dir0=[ASC-nulls-first], dir1=[DESC-nulls-last])
         +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
            +- LogicalProject(c=[$2], a=[$0], b=[$1])
               +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- NestedLoopJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], build=[right])
   :- Exchange(distribution=[any], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0], where=[>(a, 1)])
   :     +- Sort(orderBy=[a ASC, b DESC], reuse_id=[1])
   :        +- Exchange(distribution=[range[a ASC, b DESC]])
   :           +- HashAggregate(isMerge=[true], groupBy=[c], select=[c, Final_SUM(sum$0) AS a, Final_SUM(sum$1) AS b])
   :              +- Exchange(distribution=[hash[c]])
   :                 +- LocalHashAggregate(groupBy=[c], select=[c, Partial_SUM(a) AS sum$0, Partial_SUM(b) AS sum$1])
   :                    +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[<(b, 10)])
         +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_SortLimit">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT c, SUM(a) a, SUM(b) b FROM x GROUP BY c ORDER BY a, b DESC LIMIT 10)
SELECT * FROM r r1, r r2 WHERE r1.a = r2.b AND r1.a > 1 AND r2.b < 10
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(c=[$0], a=[$1], b=[$2], c0=[$3], a0=[$4], b0=[$5])
+- LogicalFilter(condition=[AND(=(CAST($1):BIGINT, $5), >($1, 1), <($5, 10))])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(sort0=[$1], sort1=[$2], dir0=[ASC-nulls-first], dir1=[DESC-nulls-last], fetch=[10])
      :  +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
      :     +- LogicalProject(c=[$2], a=[$0], b=[$1])
      :        +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(sort0=[$1], sort1=[$2], dir0=[ASC-nulls-first], dir1=[DESC-nulls-last], fetch=[10])
         +- LogicalAggregate(group=[{0}], a=[SUM($1)], b=[SUM($2)])
            +- LogicalProject(c=[$2], a=[$0], b=[$1])
               +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[c, a, b, c0, a1 AS a0, b0])
+- NestedLoopJoin(where=[=(a0, b0)], join=[c, a, b, a0, c0, a1, b0], joinType=[InnerJoin], build=[right])
   :- Exchange(distribution=[any], exchange_mode=[BATCH])
   :  +- Calc(select=[c, a, b, CAST(a) AS a0], where=[>(a, 1)])
   :     +- SortLimit(orderBy=[a ASC, b DESC], offset=[0], limit=[10], global=[true], reuse_id=[1])
   :        +- Exchange(distribution=[single])
   :           +- SortLimit(orderBy=[a ASC, b DESC], offset=[0], limit=[10], global=[false])
   :              +- HashAggregate(isMerge=[true], groupBy=[c], select=[c, Final_SUM(sum$0) AS a, Final_SUM(sum$1) AS b])
   :                 +- Exchange(distribution=[hash[c]])
   :                    +- LocalHashAggregate(groupBy=[c], select=[c, Partial_SUM(a) AS sum$0, Partial_SUM(b) AS sum$1])
   :                       +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   +- Exchange(distribution=[broadcast])
      +- Calc(select=[c, a, b], where=[<(b, 10)])
         +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Union">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, c FROM x WHERE b > 10 UNION ALL SELECT d, f FROM y WHERE e < 100)
SELECT r1.a, r1.c, r2.c FROM r r1, r r2 WHERE r1.a = r2.a
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], c=[$1], c0=[$3])
+- LogicalFilter(condition=[=($0, $2)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalUnion(all=[true])
      :  :- LogicalProject(a=[$0], c=[$2])
      :  :  +- LogicalFilter(condition=[>($1, 10)])
      :  :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      :  +- LogicalProject(d=[$0], f=[$2])
      :     +- LogicalFilter(condition=[<($1, 100)])
      :        +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
      +- LogicalUnion(all=[true])
         :- LogicalProject(a=[$0], c=[$2])
         :  +- LogicalFilter(condition=[>($1, 10)])
         :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
         +- LogicalProject(d=[$0], f=[$2])
            +- LogicalFilter(condition=[<($1, 100)])
               +- LogicalTableScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, c, c0])
+- HashJoin(where=[=(a, a0)], join=[a, c, a0, c0], joinType=[InnerJoin], isBroadcast=[true], build=[right])
   :- Exchange(distribution=[hash[a]], exchange_mode=[BATCH])
   :  +- Union(all=[true], union=[a, c], reuse_id=[1])
   :     :- Calc(select=[a, c], where=[>(b, 10)])
   :     :  +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]], fields=[a, b, c])
   :     +- Calc(select=[d, f], where=[<(e, 100)])
   :        +- TableSourceScan(table=[[builtin, default, y, source: [selectedFields=[d, e, f]]]], fields=[d, e, f])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
  <TestCase name="testSubplanReuse_Source_With_Limit">
    <Resource name="sql">
      <![CDATA[
WITH r AS (SELECT a, b FROM x LIMIT 10)
SELECT r1.a, r1.b, r2.a FROM r r1, r r2 WHERE r1.a = r2.b
      ]]>
    </Resource>
    <Resource name="planBefore">
      <![CDATA[
LogicalProject(a=[$0], b=[$1], a0=[$2])
+- LogicalFilter(condition=[=(CAST($0):BIGINT, $3)])
   +- LogicalJoin(condition=[true], joinType=[inner])
      :- LogicalSort(fetch=[10])
      :  +- LogicalProject(a=[$0], b=[$1])
      :     +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
      +- LogicalSort(fetch=[10])
         +- LogicalProject(a=[$0], b=[$1])
            +- LogicalTableScan(table=[[builtin, default, x, source: [selectedFields=[a, b, c]]]])
]]>
    </Resource>
    <Resource name="planAfter">
      <![CDATA[
Calc(select=[a, b, a1 AS a0])
+- NestedLoopJoin(where=[=(a0, b0)], join=[a, b, a0, a1, b0], joinType=[InnerJoin], build=[right])
   :- Exchange(distribution=[any], exchange_mode=[BATCH])
   :  +- Calc(select=[a, b, CAST(a) AS a0])
   :     +- Limit(offset=[0], limit=[10], global=[true], reuse_id=[1])
   :        +- Exchange(distribution=[single])
   :           +- Limit(offset=[0], limit=[10], global=[false])
   :              +- TableSourceScan(table=[[builtin, default, x, source: [selectedFields=[a, b]]]], fields=[a, b])
   +- Exchange(distribution=[broadcast])
      +- Reused(reference_id=[1])
]]>
    </Resource>
  </TestCase>
</Root>
